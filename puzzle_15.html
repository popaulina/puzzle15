<!DOCTYPE html>
<html>
<head>
<title></title>
</head>

<body>
<div id="container">
</div>
</body>

</html>

<style type="text/css">
	* {
		margin: 0;
		padding: 0;
	}

	.box {
		width: 50px;
		height: 50px;
		position: absolute;
		float: left;
		border: 1px solid;
		background-color: grey;
		opacity: .7;
		color: white;
		text-align: center;
	}
</style>

<script type="text/javascript">
	//dom setup
	var container = document.getElementById("container");
	var boxes = {};
	//create boxes and move them accordingly
	for (i=0; i<15; i++) {
	    var div = document.createElement('div');
	    div.setAttribute("id", i);
	    div.setAttribute("class", "box");
	    
	    var column = i%4;
	    div.style.marginLeft = (50 * column) + "px";
	    var row = Math.floor(i/4);
	    div.style.marginTop = (50 * row) + "px";

	    div.innerHTML = '<p>' + (i+1) + '</p>';
	    container.appendChild(div);

	    boxes[i] = {box: div, row: row, column: column};
	}
	
	//the empty square
	var emptySpace = document.createElement('div');
	emptySpace.setAttribute("id", "empty");
	emptySpace.setAttribute("class", "box");
	emptySpace.style.marginLeft = '150px';
	emptySpace.style.marginTop = '150px';
	emptySpace.style['background-color'] = 'white';
	container.appendChild(emptySpace);
	var emptyBox = {box: emptySpace, row: 3, column: 3};

	//global variables
	//checking for matches, holding click
	var matchingColumn = false;
	var matchingRow = false;
	var mouseUp = true;
	//how far the boxes have been moved 
	var distance = 0;
	//boxes to be moved
	var pickedBox = null;
	var matchedBoxes = [];
	//position of mouse when clicked
	var originalPos = {x: 0, y: 0};
	//direction of travel
	var directionEnum = {
		RIGHT: 0,
		LEFT: 1,
		UP: 2,
		DOWN: 3
	};
	var direction = null;

	document.body.onmousedown = function(e) {
		originalPos.x = e.screenX;
		originalPos.y = e.screenY;

		e = e || window.event;
  		var elementId = (e.target || e.srcElement).id;
		if (isNaN(elementId)) return;

		//get the box, find if it is valid to move
		pickedBox = boxes[elementId];
		if (pickedBox.row === emptyBox.row) {
			matchingRow = true; 
			if (pickedBox.column < emptyBox.column) direction = directionEnum.RIGHT;
			else direction = directionEnum.LEFT;
		}
		else if (pickedBox.column === emptyBox.column) {
			matchingColumn = true; 
			if (pickedBox.row < emptyBox.row) direction = directionEnum.DOWN;
			else direction = directionEnum.UP;
		}

		//find all boxes that need to be moved
		if (matchingRow) matchedBoxes = findBoxesInRow(pickedBox); 
		else if (matchingColumn) matchedBoxes = findBoxesInColumn(pickedBox); 

		if (!matchingColumn && !matchingRow) return;

		mouseUp = false;
	}

	document.body.onmouseup = function() {
		mouseUp = true;
		matchingColumn = false;
		matchingRow = false;

		if (direction === directionEnum.RIGHT || direction === directionEnum.DOWN) {
			if (distance >= 50) {
				completeMove();
			}
			else {
				resetBoxes();
				return;
			}
		} 
		else {
			if (distance <= -50) {
				completeMove();
			}
			else {
				resetBoxes();
				return;
			}
		}

	}

	document.body.onmousemove = function(e) {
		if (!mouseUp) {
			//now we check what direction to change the margin for, and move the boxes
			if (matchingRow) {
				distance = e.screenX - originalPos.x;
			 	if (direction === directionEnum.RIGHT && inBetween(distance, 0, 50)) {
					matchedBoxes.forEach(x => x.box.style.marginLeft = ((x.column * 50) + distance) + "px");
				}
				if (direction === directionEnum.LEFT && inBetween(distance, 0, -50)) {
					matchedBoxes.forEach(x => x.box.style.marginLeft = ((x.column * 50) + distance) + "px");
				}
			}

			if (matchingColumn) {
				distance = e.screenY - originalPos.y;
			 	if (direction === directionEnum.UP && inBetween(distance, 0, -50)) {
					matchedBoxes.forEach(x => x.box.style.marginTop = ((x.row * 50) + distance) + "px");
				}
				if (direction === directionEnum.DOWN && inBetween(distance, 0, 50)) {
					matchedBoxes.forEach(x => x.box.style.marginTop = ((x.row * 50) + distance) + "px");
				}
			}
		}
	}

	//find any boxes in between the chosen box and empty space that should be moved
	function findBoxesInRow(pickedBox) {
		var boxesToMove = [pickedBox];
		Object.keys(boxes).forEach(function(id) {
			var found = boxes[id];	
			if (found.row == pickedBox.row && inBetween(found.column, pickedBox.column, emptyBox.column)) 
				boxesToMove.push(found);		
		});
		return boxesToMove;
	}

	function findBoxesInColumn(pickedBox) {
		var boxesToMove = [pickedBox];
		Object.keys(boxes).forEach(function(id) {
			var found = boxes[id];	
			if (found.column == pickedBox.column && inBetween(found.row, pickedBox.row, emptyBox.row)) 
				boxesToMove.push(found);		
		});
		return boxesToMove;
	}

	function inBetween(num, first, second) {
		return (first < num && num < second) 
				|| (second < num && num < first);
	}

	function resetBoxes() {
		distance = 0;
		matchedBoxes.forEach(x => x.box.style.marginLeft = (x.column * 50) + "px");
		matchedBoxes.forEach(x => x.box.style.marginTop = (x.row * 50) + "px");
	}

	function completeMove() {
		distance = 0;
		emptyBox.row = pickedBox.row;
		emptyBox.column = pickedBox.column;
		emptyBox.box.style.marginLeft = (emptyBox.column * 50) + "px";
		emptyBox.box.style.marginTop = (emptyBox.row * 50) + "px";

		matchedBoxes.forEach(function (x) {
			if (direction === directionEnum.RIGHT) {
				x.column = x.column + 1;
				x.box.style.marginLeft = (x.column * 50) + "px";
			}
			else if (direction === directionEnum.LEFT) {
				x.column = x.column - 1;
				x.box.style.marginLeft = (x.column * 50) + "px";
			}
			else if (direction === directionEnum.UP) {
				x.row = x.row - 1;
				x.box.style.marginTop = (x.row * 50) + "px";
			}
			else {
				x.row = x.row + 1;
				x.box.style.marginTop = (x.row * 50) + "px";
			}
		});
	}
</script>